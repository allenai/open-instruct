<!DOCTYPE html>
<html>
<head>
    <title>ActorManager Dashboard</title>
    <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
    <div class="refresh-indicator"></div>
    <div class="container">
        <h1>üéõÔ∏è ActorManager Dashboard</h1>
        <div id="status-container">
            <div class="status-card">
                <div class="status-label">Loading...</div>
            </div>
        </div>
        <h2>üìä Queue Status</h2>
        <div id="queue-container">
            <div class="queue-card">
                <div class="queue-name">Loading queues...</div>
            </div>
        </div>
        <h2>‚ö° Token Throughput</h2>
        <div id="token-container">
            <div class="token-card">
                <div class="token-grid">
                    <div class="token-stat">
                        <div class="token-label">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <h2>‚è±Ô∏è Performance Metrics</h2>
        <div id="timing-container">
            <div class="token-card" style="border-left-color: #9C27B0;">
                <div class="token-grid">
                    <div class="token-stat">
                        <div class="token-label">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <h2>üéØ Training Progress</h2>
        <div id="training-progress-container">
            <div class="token-card" style="border-left-color: #4CAF50;">
                <div class="token-grid">
                    <div class="token-stat">
                        <div class="token-label">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <h2>üß† Model Utilization</h2>
        <div id="model-utilization-container">
            <div class="token-card" style="border-left-color: #E91E63;">
                <div class="token-grid">
                    <div class="token-stat">
                        <div class="token-label">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <h2>üíæ Memory Usage</h2>
        <div id="memory-usage-container">
            <div class="token-card" style="border-left-color: #FF9800;">
                <div class="token-grid">
                    <div class="token-stat">
                        <div class="token-label">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <h2>üíæ KV Cache</h2>
        <div id="kv-cache-container">
            <div class="token-card" style="border-left-color: #FF9800;">
                <div class="token-grid">
                    <div class="token-stat">
                        <div class="token-label">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        async function updateStatus() {
            const response = await fetch('/api/status');
            const data = await response.json();

            const statusClass = data.should_stop ? 'active' : 'inactive';
            const statusText = data.should_stop ? 'TRUE' : 'FALSE';

            document.getElementById('status-container').innerHTML = `
                <div class="status-card ${statusClass}">
                    <div class="status-label">Should Stop Status</div>
                    <div class="status-value ${statusClass}">${statusText}</div>
                    <div class="timestamp">Last updated: ${data.last_updated}</div>
                </div>
            `;

            // Update queue visualizations
            if (data.queues) {
                let queueHtml = '';
                for (const [queueName, queueInfo] of Object.entries(data.queues)) {
                    const percentage = queueInfo.maxsize > 0
                        ? Math.round((queueInfo.current / queueInfo.maxsize) * 100)
                        : 0;

                    let barClass = '';
                    if (percentage >= 90) {
                        barClass = 'danger';
                    } else if (percentage >= 70) {
                        barClass = 'warning';
                    }

                    queueHtml += `
                        <div class="queue-card">
                            <div class="queue-name">${queueName}</div>
                            <div class="queue-stats">
                                Current: ${queueInfo.current} / Max: ${queueInfo.maxsize}
                                (${percentage}% full)
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-text">${queueInfo.current} / ${queueInfo.maxsize}</div>
                                <div class="progress-bar ${barClass}" style="width: ${percentage}%;">
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (queueHtml === '') {
                    queueHtml = `
                        <div class="queue-card">
                            <div class="queue-name">No queues configured</div>
                        </div>
                    `;
                }

                document.getElementById('queue-container').innerHTML = queueHtml;
            }

            // Update token statistics
            if (data.token_stats) {
                const stats = data.token_stats;
                const formatNumber = (num) => {
                    if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                    if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
                    return num.toFixed(0);
                };
                
                const formatTokensPerSecond = (num) => {
                    if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                    if (num >= 36500) return (num / 1000).toFixed(1) + 'k';
                    if (num >= 1000) return num.toLocaleString('en-US');
                    return num.toFixed(1);
                };

                document.getElementById('token-container').innerHTML = `
                    <div class="token-card">
                        <div class="token-grid">
                            <div class="token-stat">
                                <div class="token-label">Prefill Tokens/Sec</div>
                                <div class="token-value">${formatTokensPerSecond(stats.prefill_tokens_per_sec)}</div>
                                <div class="token-rate">Avg over ${stats.sample_count} samples | Total: ${formatNumber(stats.total_prefill_tokens)}</div>
                            </div>
                            <div class="token-stat">
                                <div class="token-label">Decode Tokens/Sec</div>
                                <div class="token-value">${formatTokensPerSecond(stats.decode_tokens_per_sec)}</div>
                                <div class="token-rate">Avg over ${stats.sample_count} samples | Total: ${formatNumber(stats.total_decode_tokens)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update timing statistics
            if (data.timing_stats) {
                const timing = data.timing_stats;
                const formatTime = (seconds) => {
                    if (seconds >= 60) return (seconds / 60).toFixed(2) + ' min';
                    return seconds.toFixed(2) + ' sec';
                };

                document.getElementById('timing-container').innerHTML = `
                    <div class="token-card" style="border-left-color: #9C27B0;">
                        <div class="token-grid">
                            <div class="token-stat">
                                <div class="token-label">Avg Training Step Time</div>
                                <div class="token-value" style="color: #9C27B0;">${formatTime(timing.avg_training_step_time)}</div>
                                <div class="token-rate">Moving avg: last ${timing.training_step_count} of 100 steps</div>
                            </div>
                            <div class="token-stat">
                                <div class="token-label">Avg Batch Generation Time</div>
                                <div class="token-value" style="color: #9C27B0;">${formatTime(timing.avg_batch_generation_time)}</div>
                                <div class="token-rate">Moving avg: last ${timing.batch_generation_count} of 100 batches</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update training progress
            if (data.training_progress) {
                const progress = data.training_progress;
                document.getElementById('training-progress-container').innerHTML = `
                    <div class="token-card" style="border-left-color: #4CAF50;">
                        <div class="token-grid">
                            <div class="token-stat">
                                <div class="token-label">Current Training Step</div>
                                <div class="token-value" style="color: #4CAF50;">${progress.current_step} / ${progress.total_steps || 'N/A'}</div>
                                <div class="token-rate">${progress.progress_percent.toFixed(1)}% complete</div>
                            </div>
                            <div class="token-stat">
                                <div class="token-label">Estimated Time Remaining</div>
                                <div class="token-value" style="color: #4CAF50;">${progress.eta_formatted}</div>
                                <div class="token-rate">Based on current training speed</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update model utilization (MFU/MBU)
            if (data.utilization_stats) {
                const util = data.utilization_stats;
                document.getElementById('model-utilization-container').innerHTML = `
                    <div class="token-card" style="border-left-color: #E91E63;">
                        <div class="token-grid">
                            <div class="token-stat">
                                <div class="token-label">Model FLOPs Utilization (MFU)</div>
                                <div class="token-value" style="color: #E91E63;">${util.mfu.toFixed(1)}%</div>
                                <div class="token-rate">Percentage of theoretical peak FLOPS (avg over ${util.sample_count} samples)</div>
                            </div>
                            <div class="token-stat">
                                <div class="token-label">Memory Bandwidth Utilization (MBU)</div>
                                <div class="token-value" style="color: #E91E63;">${util.mbu.toFixed(1)}%</div>
                                <div class="token-rate">Percentage of theoretical peak memory bandwidth (avg over ${util.sample_count} samples)</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('model-utilization-container').innerHTML = `
                    <div class="token-card" style="border-left-color: #E91E63;">
                        <div class="token-grid">
                            <div class="token-stat">
                                <div class="token-label">Model FLOPs Utilization (MFU)</div>
                                <div class="token-value" style="color: #E91E63;">Collecting...</div>
                                <div class="token-rate">Percentage of theoretical peak FLOPS</div>
                            </div>
                            <div class="token-stat">
                                <div class="token-label">Memory Bandwidth Utilization (MBU)</div>
                                <div class="token-value" style="color: #E91E63;">Collecting...</div>
                                <div class="token-rate">Percentage of theoretical peak memory bandwidth</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update memory usage
            if (data.memory_stats) {
                const mem = data.memory_stats;
                document.getElementById('memory-usage-container').innerHTML = `
                    <div class="token-card" style="border-left-color: #FF9800;">
                        <div class="token-grid">
                            <div class="token-stat">
                                <div class="token-label">Average KV Cache Size</div>
                                <div class="token-value" style="color: #FF9800;">${mem.average_kv_cache_size.toFixed(2)} GB</div>
                                <div class="token-rate">Per actor KV cache memory usage</div>
                            </div>
                            <div class="token-stat">
                                <div class="token-label">Total GPU Memory Usage</div>
                                <div class="token-value" style="color: #FF9800;">${mem.total_gpu_memory_used.toFixed(2)} GB</div>
                                <div class="token-rate">Across all inference actors (peak: ${mem.peak_memory_usage.toFixed(2)} GB)</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('memory-usage-container').innerHTML = `
                    <div class="token-card" style="border-left-color: #FF9800;">
                        <div class="token-grid">
                            <div class="token-stat">
                                <div class="token-label">Average KV Cache Size</div>
                                <div class="token-value" style="color: #FF9800;">Collecting...</div>
                                <div class="token-rate">Per actor KV cache memory usage</div>
                            </div>
                            <div class="token-stat">
                                <div class="token-label">Total GPU Memory Usage</div>
                                <div class="token-value" style="color: #FF9800;">Collecting...</div>
                                <div class="token-rate">Across all inference actors</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update KV cache statistics
            if (data.kv_cache_max_concurrency !== null && data.kv_cache_max_concurrency !== undefined) {
                let kvCacheHtml = `
                    <div class="token-card" style="border-left-color: #FF9800;">
                        <div class="token-grid">
                            <div class="token-stat">
                                <div class="token-label">Max Theoretical Generation Concurrency</div>
                                <div class="token-value" style="color: #FF9800;">${data.kv_cache_max_concurrency}</div>
                                <div class="token-rate">Maximum concurrent generations supported by KV cache configuration</div>
                            </div>
                `;

                if (data.inference_batch_size !== null && data.inference_batch_size !== undefined) {
                    kvCacheHtml += `
                            <div class="token-stat">
                                <div class="token-label">Inference Batch Size</div>
                                <div class="token-value" style="color: #FF9800;">${data.inference_batch_size}</div>
                                <div class="token-rate">Number of prompts processed per vLLM engine batch</div>
                            </div>
                    `;
                }

                kvCacheHtml += `
                        </div>
                    </div>
                `;

                document.getElementById('kv-cache-container').innerHTML = kvCacheHtml;
            }
        }

        // Update immediately and then every second
        updateStatus();
        setInterval(updateStatus, 1000);
    </script>
</body>
</html>
