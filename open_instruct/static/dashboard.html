<!DOCTYPE html>
<html>
<head>
    <title>ActorManager Dashboard</title>
    <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
    <div class="refresh-indicator"></div>
    <div class="container">
        <h1>üéõÔ∏è ActorManager Dashboard</h1>
        <div id="status-container">
            <div class="status-card">
                <div class="status-label">Loading...</div>
            </div>
        </div>
        <h2>üìä Queue Status</h2>
        <div id="queue-container">
            <div class="queue-card">
                <div class="queue-name">Loading queues...</div>
            </div>
        </div>
        <h2>‚ö° Token Throughput</h2>
        <div id="token-container">
            <div class="token-card">
                <div class="token-grid">
                    <div class="token-stat">
                        <div class="token-label">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <h2>‚è±Ô∏è Performance Metrics</h2>
        <div id="timing-container">
            <div class="token-card" style="border-left-color: #9C27B0;">
                <div class="token-grid">
                    <div class="token-stat">
                        <div class="token-label">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <h2>üíæ KV Cache</h2>
        <div id="kv-cache-container">
            <div class="token-card" style="border-left-color: #FF9800;">
                <div class="token-grid">
                    <div class="token-stat">
                        <div class="token-label">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        function logError(message, error = null) {
            const timestamp = new Date().toISOString();
            console.error(`[${timestamp}] Dashboard Error: ${message}`, error);
            
            // Show error in the UI
            const statusContainer = document.getElementById('status-container');
            if (statusContainer) {
                statusContainer.innerHTML = `
                    <div class="status-card" style="border-color: #f44336; background-color: #ffebee;">
                        <div class="status-label">Dashboard Error</div>
                        <div class="status-value" style="color: #f44336;">${message}</div>
                        <div class="timestamp">Error at: ${timestamp}</div>
                    </div>
                `;
            }
        }

        async function updateStatus() {
            try {
                console.log('Fetching status from /api/status...');
                const response = await fetch('/api/status');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Successfully fetched status data:', data);

            const statusClass = data.should_stop ? 'active' : 'inactive';
            const statusText = data.should_stop ? 'TRUE' : 'FALSE';

            document.getElementById('status-container').innerHTML = `
                <div class="status-card ${statusClass}">
                    <div class="status-label">Should Stop Status</div>
                    <div class="status-value ${statusClass}">${statusText}</div>
                    <div class="timestamp">Last updated: ${data.last_updated}</div>
                </div>
            `;

            // Update queue visualizations
            try {
                if (data.queues) {
                    console.log(`Updating ${Object.keys(data.queues).length} queues`);
                    let queueHtml = '';
                    for (const [queueName, queueInfo] of Object.entries(data.queues)) {
                        const percentage = queueInfo.maxsize > 0
                            ? Math.round((queueInfo.current / queueInfo.maxsize) * 100)
                            : 0;

                        let barClass = '';
                        if (percentage >= 90) {
                            barClass = 'danger';
                        } else if (percentage >= 70) {
                            barClass = 'warning';
                        }

                        queueHtml += `
                            <div class="queue-card">
                                <div class="queue-name">${queueName}</div>
                                <div class="queue-stats">
                                    Current: ${queueInfo.current} / Max: ${queueInfo.maxsize}
                                    (${percentage}% full)
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-text">${queueInfo.current} / ${queueInfo.maxsize}</div>
                                    <div class="progress-bar ${barClass}" style="width: ${percentage}%;">
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    if (queueHtml === '') {
                        queueHtml = `
                            <div class="queue-card">
                                <div class="queue-name">No queues configured</div>
                            </div>
                        `;
                    }

                    document.getElementById('queue-container').innerHTML = queueHtml;
                } else {
                    console.warn('No queues data in response');
                }
            } catch (error) {
                logError('Error updating queues', error);
            }

            // Update token statistics
            try {
                if (data.token_stats) {
                    console.log('Updating token statistics');
                    const stats = data.token_stats;
                    const formatNumber = (num) => {
                        if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                        if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
                        return num.toFixed(0);
                    };

                    document.getElementById('token-container').innerHTML = `
                        <div class="token-card">
                            <div class="token-grid">
                                <div class="token-stat">
                                    <div class="token-label">Prefill Tokens/Sec</div>
                                    <div class="token-value">${stats.prefill_tokens_per_sec.toFixed(1)}</div>
                                    <div class="token-rate">Avg over ${stats.sample_count} samples | Total: ${formatNumber(stats.total_prefill_tokens)}</div>
                                </div>
                                <div class="token-stat">
                                    <div class="token-label">Decode Tokens/Sec</div>
                                    <div class="token-value">${stats.decode_tokens_per_sec.toFixed(1)}</div>
                                    <div class="token-rate">Avg over ${stats.sample_count} samples | Total: ${formatNumber(stats.total_decode_tokens)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    console.warn('No token_stats data in response');
                }
            } catch (error) {
                logError('Error updating token statistics', error);
            }

            // Update timing statistics
            try {
                if (data.timing_stats) {
                    console.log('Updating timing statistics');
                    const timing = data.timing_stats;
                    const formatTime = (seconds) => {
                        if (seconds >= 60) return (seconds / 60).toFixed(2) + ' min';
                        return seconds.toFixed(2) + ' sec';
                    };

                    document.getElementById('timing-container').innerHTML = `
                        <div class="token-card" style="border-left-color: #9C27B0;">
                            <div class="token-grid">
                                <div class="token-stat">
                                    <div class="token-label">Avg Training Step Time</div>
                                    <div class="token-value" style="color: #9C27B0;">${formatTime(timing.avg_training_step_time)}</div>
                                    <div class="token-rate">Moving avg: last ${timing.training_step_count} of 100 steps</div>
                                </div>
                                <div class="token-stat">
                                    <div class="token-label">Avg Batch Generation Time</div>
                                    <div class="token-value" style="color: #9C27B0;">${formatTime(timing.avg_batch_generation_time)}</div>
                                    <div class="token-rate">Moving avg: last ${timing.batch_generation_count} of 100 batches</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    console.warn('No timing_stats data in response');
                }
            } catch (error) {
                logError('Error updating timing statistics', error);
            }

            // Update KV cache statistics
            try {
                if (data.kv_cache_max_concurrency !== null && data.kv_cache_max_concurrency !== undefined) {
                    console.log('Updating KV cache statistics');
                    let kvCacheHtml = `
                        <div class="token-card" style="border-left-color: #FF9800;">
                            <div class="token-grid">
                                <div class="token-stat">
                                    <div class="token-label">Max Theoretical Generation Concurrency</div>
                                    <div class="token-value" style="color: #FF9800;">${data.kv_cache_max_concurrency}</div>
                                    <div class="token-rate">Maximum concurrent generations supported by KV cache configuration</div>
                                </div>
                    `;

                    if (data.inference_batch_size !== null && data.inference_batch_size !== undefined) {
                        kvCacheHtml += `
                                <div class="token-stat">
                                    <div class="token-label">Inference Batch Size</div>
                                    <div class="token-value" style="color: #FF9800;">${data.inference_batch_size}</div>
                                    <div class="token-rate">Number of prompts processed per vLLM engine batch</div>
                                </div>
                        `;
                    }

                    kvCacheHtml += `
                            </div>
                        </div>
                    `;

                    document.getElementById('kv-cache-container').innerHTML = kvCacheHtml;
                } else {
                    console.warn('No KV cache data in response');
                }
            } catch (error) {
                logError('Error updating KV cache statistics', error);
            }
            
            } catch (error) {
                logError('Failed to fetch or process status data', error);
            }
        }

        // Update immediately and then every second
        console.log('Dashboard initialized, starting status updates...');
        updateStatus();
        setInterval(updateStatus, 1000);
        
        // Add global error handler
        window.addEventListener('error', function(event) {
            logError(`Global error: ${event.error.message}`, event.error);
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            logError(`Unhandled promise rejection: ${event.reason}`, event.reason);
        });
    </script>
</body>
</html>
