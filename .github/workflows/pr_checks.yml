name: PR Checks

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    branches:
      - main
  merge_group:

jobs:
  changelog:
    name: CHANGELOG
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check that CHANGELOG has been updated
      run: |
        # Check for CHANGELOG bypass in PR body
        PR_BODY='${{ github.event.pull_request.body }}'
        if echo "$PR_BODY" | grep -q 'CHANGELOG='; then
          REASON=$(echo "$PR_BODY" | grep -oP 'CHANGELOG=\K[^\n\r]*' | head -1)
          echo "CHANGELOG check bypassed. Reason: $REASON"
          exit 0
        fi

        # Only require changelog for open_instruct/** changes
        if git diff --name-only $(git merge-base origin/main HEAD) | grep -q '^open_instruct/'; then
          git diff --name-only $(git merge-base origin/main HEAD) | grep '^CHANGELOG.md$' && echo "Thanks for helping keep our CHANGELOG up-to-date!"
        else
          echo "No open_instruct/ changes detected, skipping CHANGELOG check"
        fi

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -euo pipefail {0}

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "0.8.8"

    - name: Style check
      run: make style-check

    - name: Quality check
      run: make quality-check
