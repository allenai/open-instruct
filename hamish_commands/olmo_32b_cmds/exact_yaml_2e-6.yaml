version: v2
description: 'Beaker-Mason job. git_commit: 8d8232cc git_branch: pad-out-32b https://wandb.ai/ai2-llm/open_instruct_internal/runs/29h723j6 [0.0% complete (step 1/9765), eta 1h 50m] git_commit: 8d8232cc git_branch: pad-out-32b https://wandb.ai/ai2-llm/open_instruct_internal/runs/29h723j6 [7.2% complete (step 700/9765), eta 61d 5h 9m]'
tasks:
  - name: beaker_mason__0
    replicas: 28
    leaderSelection: true
    image:
      beaker: hamishivi/open_instruct_rl32_no_ref19
    command: [/bin/bash, -c]
    arguments: ['mkdir -p /gs/ai2-llm/post-training/deletable_cache_models/test_dpo_olmo3_32b_res100_s1_lr2e-6_13694/f08903fb && gsutil -o GSUtil:parallel_thread_count=1 -o GSUtil:sliced_object_download_threshold=150 -m cp -r gs://ai2-llm/post-training/deletable_cache_models/test_dpo_olmo3_32b_res100_s1_lr2e-6_13694/f08903fb /gs/ai2-llm/post-training/deletable_cache_models/test_dpo_olmo3_32b_res100_s1_lr2e-6_13694 && ls /gs/ai2-llm/post-training/deletable_cache_models/test_dpo_olmo3_32b_res100_s1_lr2e-6_13694 && ls /gs/ai2-llm/post-training/deletable_cache_models/test_dpo_olmo3_32b_res100_s1_lr2e-6_13694/f08903fb && mkdir -p /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && gsutil cp -r gs://ai2-llm/post-training/deletable_cache_datasets//weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache/eda7010d65 /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && ls /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && ls /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache/eda7010d65 && mkdir -p /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && gsutil cp -r gs://ai2-llm/post-training/deletable_cache_datasets//weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache/b7e8474ca5 /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && ls /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && ls /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache/b7e8474ca5 && source configs/beaker_configs/ray_node_setup.sh && source configs/beaker_configs/code_api_setup.sh && python open_instruct/grpo_fast.py --exp_name test_dpo_olmo3_32b_res100_s1_lr2e-6_27200 --beta 0.0 --num_samples_per_prompt_rollout 8 --num_unique_prompts_rollout 128 --num_mini_batches 1 --num_epochs 1 --learning_rate 2e-6 --per_device_train_batch_size 1 --output_dir /output --kl_estimator kl3 --dataset_mixer_list hamishivi/math_rlvr_mixture_dpo 1.0 saurabh5/code_rlvr_mixture_dpo 1.0 allenai/IF_multi_constraints_upto5_filtered_dpo_0625_filter-keyword-filtered-topic-char-topic-filtered 30186 allenai/rlvr_general_mix-keyword-filtered-topic-chars-char-filt-topic-filtered 21387 --dataset_mixer_list_splits train --dataset_mixer_eval_list hamishivi/omega-combined 8 allenai/IF_multi_constraints_upto5 8 saurabh5/rlvr_acecoder_filtered 8 hamishivi/tulu_3_rewritten_400k_string_f1_only_v2_nocode_all_filtered_qwen2_5_openthoughts2 4 hamishivi/virtuoussy_multi_subject_rlvr 4 --dataset_mixer_eval_list_splits train --max_prompt_token_length 2048 --response_length 32768 --pack_length 35840 --model_name_or_path /gs/ai2-llm/post-training/deletable_cache_models/test_dpo_olmo3_32b_res100_s1_lr2e-6_13694/f08903fb --chat_template_name olmo_thinker --non_stop_penalty False --mask_truncated_completions False --temperature 1.0 --ground_truths_key ground_truth --sft_messages_key messages --total_episodes 10000000 --deepspeed_stage 3 --num_learners_per_node 8 8 8 8 8 8 8 8 --vllm_num_engines 20 --inference_batch_size 200 --gather_whole_model False --vllm_tensor_parallel_size 8 --lr_scheduler_type constant --apply_verifiable_reward true --seed 1 --local_eval_every 50 --save_freq 50 --beaker_eval_freq 50 --eval_priority urgent --try_launch_beaker_eval_jobs_on_weka True --gradient_checkpointing --with_tracking --llm_judge_model hosted_vllm/Qwen/Qwen3-32B --llm_judge_timeout 600 --llm_judge_max_tokens 2048 --llm_judge_max_context_length 32768 --clip_higher 0.272 --allow_world_padding False --use_fp8_kv_cache False --code_api_url https://p9f1719l7f.execute-api.us-west-2.amazonaws.com/prod/test_program --code_pass_rate_reward_threshold 0.99 --code_max_execution_time 6 --oe_eval_max_length 32768 --checkpoint_state_freq 5 --backend_timeout 1200 --inflight_updates true --async_steps 8 --active_sampling --advantage_normalization_type centered --truncated_importance_sampling_ratio_cap 2.0 --oe_eval_tasks mmlu:cot::hamish_zs_reasoning_deepseek,bbh:cot::hamish_zs_reasoning_deepseek_v2,gpqa:0shot_cot::qwen3-instruct,zebralogic::hamish_zs_reasoning_deepseek,agi_eval_english:0shot_cot::hamish_zs_reasoning_deepseek,omega_500:0-shot-chat_deepseek,aime:zs_cot_r1::pass_at_32_2024_deepseek,aime:zs_cot_r1::pass_at_32_2025_deepseek,codex_humanevalplus:0-shot-chat::tulu-thinker_deepseek,mbppplus:0-shot-chat::tulu-thinker_deepseek,livecodebench_codegeneration::tulu-thinker_deepseek_no_think_tags_lite,alpaca_eval_v3::hamish_zs_reasoning_deepseek,ifeval::hamish_zs_reasoning_deepseek --oe_eval_gpu_multiplier 2 --vllm_enforce_eager --deepspeed_zpg 1 --hf_entity allenai --wandb_entity ai2-llm --checkpoint_state_dir /weka/oe-adapt-default/allennlp/deletable_checkpoint_states/hamishivi/1763251592_971438 --checkpoint_state_freq 5 --gs_bucket_path gs://ai2-llm/post-training/ --dataset_config_hash eda7010d65 --dataset_config_eval_hash b7e8474ca5']
    envVars:
      - name: RAY_CGRAPH_get_timeout
        value: "300"
      - name: VLLM_DISABLE_COMPILE_CACHE
        value: "1"
      - name: NCCL_DEBUG
        value: ERROR
      - name: VLLM_LOGGING_LEVEL
        value: WARNING
      - name: VLLM_USE_V1
        value: "1"
      - name: VLLM_ALLOW_INSECURE_SERIALIZATION
        value: "1"
      - name: VLLM_ALLOW_LONG_MAX_MODEL_LEN
        value: "1"
      - name: PYTORCH_CUDA_ALLOC_CONF
        value: expandable_segments:True
      - name: LD_LIBRARY_PATH
        value: /var/lib/tcpxo/lib64
      - name: NCCL_LIB_DIR
        value: /var/lib/tcpxo/lib64
      - name: HOSTED_VLLM_API_BASE
        value: http://saturn-cs-aus-235.reviz.ai2.in:8001/v1
      - name: HF_TOKEN
        secret: hamishivi_HF_TOKEN
      - name: WANDB_API_KEY
        secret: hamishivi_WANDB_API_KEY
      - name: BEAKER_TOKEN
        secret: hamishivi_BEAKER_TOKEN
      - name: OPENAI_API_KEY
        secret: hamishivi_OPENAI_API_KEY
      - name: SLACK_WEBHOOK
        secret: hamishivi_SLACK_WEBHOOK
      - name: HF_HOME
        value: /filestore/.cache/huggingface
      - name: HF_DATASETS_CACHE
        value: /filestore/.cache/huggingface
      - name: HF_HUB_CACHE
        value: /filestore/.cache/hub
      - name: HF_HUB_ENABLE_HF_TRANSFER
        value: "0"
      - name: NCCL_CROSS_NIC
        value: "0"
      - name: NCCL_PROTO
        value: Simple,LL128
      - name: NCCL_MIN_NCHANNELS
        value: "4"
      - name: NCCL_P2P_NET_CHUNKSIZE
        value: "524288"
      - name: NCCL_P2P_PCI_CHUNKSIZE
        value: "524288"
      - name: NCCL_P2P_NVL_CHUNKSIZE
        value: "1048576"
      - name: NCCL_NVLSTREE_MAX_CHUNKSIZE
        value: "131072"
      - name: NCCL_FASTRAK_NUM_FLOWS
        value: "2"
      - name: NCCL_FASTRAK_ENABLE_CONTROL_CHANNEL
        value: "0"
      - name: NCCL_BUFFSIZE
        value: "8388608"
      - name: NCCL_FASTRAK_USE_SNAP
        value: "1"
      - name: CUDA_VISIBLE_DEVICES
        value: 0,1,2,3,4,5,6,7
      - name: NCCL_NET_GDR_LEVEL
        value: PIX
      - name: NCCL_FASTRAK_ENABLE_HOTPATH_LOGGING
        value: "0"
      - name: NCCL_FASTRAK_PLUGIN_ACCEPT_TIMEOUT_MS
        value: "600000"
      - name: NCCL_USE_SNAP
        value: "1"
      - name: NCCL_FASTRAK_USE_LLCM
        value: "1"
      - name: NCCL_FASTRAK_LLCM_DEVICE_DIRECTORY
        value: /dev/aperture_devices
      - name: NCCL_TUNER_PLUGIN
        value: libnccl-tuner.so
      - name: NCCL_TUNER_CONFIG_PATH
        value: /var/lib/tcpxo/lib64/a3plus_tuner_config_ll128.textproto
      - name: NCCL_SHIMNET_GUEST_CONFIG_CHECKER_CONFIG_FILE
        value: /var/lib/tcpxo/lib64/a3plus_guest_config_ll128.textproto
      - name: NCCL_FASTRAK_CTRL_DEV
        value: enp0s12
      - name: NCCL_FASTRAK_IFNAME
        value: enp6s0,enp7s0,enp13s0,enp14s0,enp134s0,enp135s0,enp141s0,enp142s0
      - name: NCCL_SOCKET_IFNAME
        value: enp0s12
      - name: NCCL_DEBUG_SUBSYS
        value: INIT,NET
      - name: WANDB_RUN_ID
        value: 29h723j6
      - name: WANDB_RESUME
        value: allow
    datasets:
      - mountPath: /filestore
        source:
          hostPath: /mnt/filestore_1
    result:
      path: /output
    resources:
      gpuCount: 8
      sharedMemory: 10240 MB
    context:
      priority: urgent
      preemptible: true
    constraints:
      cluster:
        - ai2/augusta
    hostNetworking: true
    propagateFailure: true
    propagatePreemption: true