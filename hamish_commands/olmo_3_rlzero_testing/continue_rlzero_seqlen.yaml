version: v2
description: 'Beaker-Mason job. git_commit: fca28ca9 git_branch: cispo-loss https://wandb.ai/ai2-llm/open_instruct_internal/runs/1030ezuq git_commit: fca28ca9 git_branch: cispo-loss https://wandb.ai/ai2-llm/open_instruct_internal/runs/1030ezuq [30.0% complete (step 600/2001), eta 7d 3h 51m] git_commit: fca28ca9 git_branch: cispo-loss https://wandb.ai/ai2-llm/open_instruct_internal/runs/1030ezuq'
tasks:
  - name: beaker_mason__0
    replicas: 8
    leaderSelection: true
    image:
      beaker: hamishivi/open_instruct_dev_3011
    command: [/bin/bash, -c]
    arguments: ['mkdir -p /gs/ai2-llm/post-training/deletable_cache_models/allenai/Olmo-3-1025-7B/803c2144d04eea827acf68247eb5871a8e4f81bf && gsutil -o GSUtil:parallel_thread_count=1 -o GSUtil:sliced_object_download_threshold=150 -m cp -r gs://ai2-llm/post-training/deletable_cache_models/allenai/Olmo-3-1025-7B/803c2144d04eea827acf68247eb5871a8e4f81bf /gs/ai2-llm/post-training/deletable_cache_models/allenai/Olmo-3-1025-7B && ls /gs/ai2-llm/post-training/deletable_cache_models/allenai/Olmo-3-1025-7B && ls /gs/ai2-llm/post-training/deletable_cache_models/allenai/Olmo-3-1025-7B/803c2144d04eea827acf68247eb5871a8e4f81bf && mkdir -p /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && gsutil cp -r gs://ai2-llm/post-training/deletable_cache_datasets//weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache/41ff57c703 /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && ls /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && ls /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache/41ff57c703 && mkdir -p /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && gsutil cp -r gs://ai2-llm/post-training/deletable_cache_datasets//weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache/861072f7c4 /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && ls /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache && ls /weka/oe-adapt-default/allennlp/deletable_open_instruct_dataset_cache/861072f7c4 && source configs/beaker_configs/ray_node_setup.sh && source configs/beaker_configs/code_api_setup.sh && python open_instruct/grpo_fast.py --exp_name olmo3_7b_rlzero_math_dapo_4 --beta 0.0 --async_steps 8 --inflight_updates --no_resampling_pass_rate 0.875 --truncated_importance_sampling_ratio_cap 2.0 --advantage_normalization_type centered --active_sampling --num_samples_per_prompt_rollout 8 --num_unique_prompts_rollout 128 --num_mini_batches 4 --learning_rate 1e-6 --per_device_train_batch_size 1 --kl_estimator kl3 --dataset_mixer_list allenai/Dolci-RLZero-Math-7B 1.0 --dataset_mixer_list_splits train --load_ref_policy False --dataset_mixer_eval_list allenai/Dolci-RLZero-Math-7B 16 --dataset_mixer_eval_list_splits train train --max_prompt_token_length 2048 --response_length 16384 --pack_length 18432 --model_name_or_path /gs/ai2-llm/post-training/deletable_cache_models/allenai/Olmo-3-1025-7B/803c2144d04eea827acf68247eb5871a8e4f81bf --chat_template_name olmo_thinker_rlzero --non_stop_penalty False --temperature 1.0 --total_episodes 2049024 --deepspeed_stage 3 --num_learners_per_node 8 8 --vllm_num_engines 48 --vllm_tensor_parallel_size 1 --lr_scheduler_type constant --apply_verifiable_reward true --seed 1 --local_eval_every 25 --save_freq 100 --checkpoint_state_freq 100 --gradient_checkpointing --with_tracking --vllm_enable_prefix_caching --clip_higher 0.272 --oe_eval_max_length 32768 --try_launch_beaker_eval_jobs_on_weka True --eval_priority high --eval_on_step_0 True --oe_eval_tasks aime:zs_cot_r1::pass_at_32_2024_rlzero,aime:zs_cot_r1::pass_at_32_2025_rlzero --oe_eval_gpu_multiplier 4 --loss_fn dapo --hf_entity allenai --wandb_entity ai2-llm --checkpoint_state_dir /weka/oe-adapt-default/allennlp/deletable_checkpoint_states/hamishivi/1764555726_480751 --checkpoint_state_freq 100 --gs_bucket_path gs://ai2-llm/post-training/ --dataset_config_hash 41ff57c703 --dataset_config_eval_hash 861072f7c4']
    envVars:
      - name: RAY_CGRAPH_get_timeout
        value: "300"
      - name: VLLM_DISABLE_COMPILE_CACHE
        value: "1"
      - name: NCCL_DEBUG
        value: ERROR
      - name: VLLM_LOGGING_LEVEL
        value: WARNING
      - name: VLLM_USE_V1
        value: "1"
      - name: VLLM_ALLOW_INSECURE_SERIALIZATION
        value: "1"
      - name: VLLM_ALLOW_LONG_MAX_MODEL_LEN
        value: "1"
      - name: PYTORCH_CUDA_ALLOC_CONF
        value: expandable_segments:True
      - name: LD_LIBRARY_PATH
        value: /var/lib/tcpxo/lib64
      - name: NCCL_LIB_DIR
        value: /var/lib/tcpxo/lib64
      - name: HOSTED_VLLM_API_BASE
        value: http://ceres-cs-aus-447.reviz.ai2.in:8001/v1
      - name: HF_TOKEN
        secret: hamishivi_HF_TOKEN
      - name: WANDB_API_KEY
        secret: hamishivi_WANDB_API_KEY
      - name: BEAKER_TOKEN
        secret: hamishivi_BEAKER_TOKEN
      - name: OPENAI_API_KEY
        secret: hamishivi_OPENAI_API_KEY
      - name: HF_HOME
        value: /filestore/.cache/huggingface
      - name: HF_DATASETS_CACHE
        value: /filestore/.cache/huggingface
      - name: HF_HUB_CACHE
        value: /filestore/.cache/hub
      - name: HF_HUB_ENABLE_HF_TRANSFER
        value: "0"
      - name: NCCL_CROSS_NIC
        value: "0"
      - name: NCCL_PROTO
        value: Simple,LL128
      - name: NCCL_MIN_NCHANNELS
        value: "4"
      - name: NCCL_P2P_NET_CHUNKSIZE
        value: "524288"
      - name: NCCL_P2P_PCI_CHUNKSIZE
        value: "524288"
      - name: NCCL_P2P_NVL_CHUNKSIZE
        value: "1048576"
      - name: NCCL_NVLSTREE_MAX_CHUNKSIZE
        value: "131072"
      - name: NCCL_FASTRAK_NUM_FLOWS
        value: "2"
      - name: NCCL_FASTRAK_ENABLE_CONTROL_CHANNEL
        value: "0"
      - name: NCCL_BUFFSIZE
        value: "8388608"
      - name: NCCL_FASTRAK_USE_SNAP
        value: "1"
      - name: CUDA_VISIBLE_DEVICES
        value: 0,1,2,3,4,5,6,7
      - name: NCCL_NET_GDR_LEVEL
        value: PIX
      - name: NCCL_FASTRAK_ENABLE_HOTPATH_LOGGING
        value: "0"
      - name: NCCL_FASTRAK_PLUGIN_ACCEPT_TIMEOUT_MS
        value: "600000"
      - name: NCCL_USE_SNAP
        value: "1"
      - name: NCCL_FASTRAK_USE_LLCM
        value: "1"
      - name: NCCL_FASTRAK_LLCM_DEVICE_DIRECTORY
        value: /dev/aperture_devices
      - name: NCCL_TUNER_PLUGIN
        value: libnccl-tuner.so
      - name: NCCL_TUNER_CONFIG_PATH
        value: /var/lib/tcpxo/lib64/a3plus_tuner_config_ll128.textproto
      - name: NCCL_SHIMNET_GUEST_CONFIG_CHECKER_CONFIG_FILE
        value: /var/lib/tcpxo/lib64/a3plus_guest_config_ll128.textproto
      - name: NCCL_FASTRAK_CTRL_DEV
        value: enp0s12
      - name: NCCL_FASTRAK_IFNAME
        value: enp6s0,enp7s0,enp13s0,enp14s0,enp134s0,enp135s0,enp141s0,enp142s0
      - name: NCCL_SOCKET_IFNAME
        value: enp0s12
      - name: NCCL_DEBUG_SUBSYS
        value: INIT,NET
      - name: WANDB_RUN_ID
        value: 1030ezuq
      - name: WANDB_RESUME
        value: allow
    datasets:
      - mountPath: /filestore
        source:
          hostPath: /mnt/filestore_1
    result:
      path: /output
    resources:
      gpuCount: 8
      sharedMemory: 10240 MB
    context:
      priority: high
      preemptible: true
    constraints:
      cluster:
        - ai2/augusta
    hostNetworking: true
    propagateFailure: true
    propagatePreemption: true