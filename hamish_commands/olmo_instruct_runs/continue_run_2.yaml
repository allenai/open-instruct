version: v2
tasks:
  - name: beaker_mason__0
    replicas: 4
    leaderSelection: true
    image:
      beaker: hamishivi/open_instruct_rl7b_new_fix
    command: [/bin/bash, -c]
    arguments: ['source configs/beaker_configs/ray_node_setup.sh && source configs/beaker_configs/code_api_setup.sh && python open_instruct/grpo_fast.py --exp_name olmo3_dpo_0711_rl_fun_mix_fix_28617 --beta 0.0 --num_samples_per_prompt_rollout 8 --num_unique_prompts_rollout 64 --num_mini_batches 1 --num_epochs 1 --learning_rate 1e-6 --per_device_train_batch_size 1 --output_dir /output --kl_estimator kl3 --dataset_mixer_list hamishivi/math_rlvr_mixture_dpo 1.0 hamishivi/code_rlvr_mixture_dpo 1.0 hamishivi/IF_multi_constraints_upto5_filtered_dpo_0625_filter 30186 hamishivi/rlvr_general_mix 21387 --dataset_mixer_list_splits train --dataset_mixer_eval_list hamishivi/omega-combined 8 allenai/IF_multi_constraints_upto5 8 saurabh5/rlvr_acecoder_filtered 8 hamishivi/tulu_3_rewritten_400k_string_f1_only_v2_nocode_all_filtered_qwen2_5_openthoughts2 4 hamishivi/virtuoussy_multi_subject_rlvr 4 --dataset_mixer_eval_list_splits train --max_token_length 10240 --max_prompt_token_length 2048 --response_length 32768 --pack_length 35840 --model_name_or_path /weka/oe-adapt-default/hamishi/model_checkpoints/sm0922-rsn-dpo-delta-yolo_scottmix1_150k-8e-8__42__1758585338_olmo25 --chat_template_name olmo_thinker --non_stop_penalty False --mask_truncated_completions False --temperature 1.0 --ground_truths_key ground_truth --sft_messages_key messages --total_episodes 10000000 --deepspeed_stage 3 --num_learners_per_node 8 8 --vllm_num_engines 16 --vllm_tensor_parallel_size 1 --lr_scheduler_type constant --apply_verifiable_reward true --seed 1 --local_eval_every 50 --save_freq 25 --beaker_eval_freq 50 --eval_priority urgent --try_launch_beaker_eval_jobs_on_weka True --gradient_checkpointing --with_tracking --llm_judge_model hosted_vllm/Qwen/Qwen3-32B --llm_judge_timeout 600 --llm_judge_max_tokens 2048 --llm_judge_max_context_length 32768 --clip_higher 0.272 --vllm_enforce_eager --allow_world_padding False --use_fp8_kv_cache False --code_api_url https://p9f1719l7f.execute-api.us-west-2.amazonaws.com/prod/test_program --code_pass_rate_reward_threshold 0.99 --oe_eval_max_length 32768 --checkpoint_state_freq 100 --backend_timeout 1200 --inflight_updates true --async_steps 8 --advantage_normalization_type centered --truncated_importance_sampling_ratio_cap 2.0 --oe_eval_beaker_image oe-eval-beaker/oe_eval_olmo2_retrofit_auto --oe_eval_tasks mmlu:cot::hamish_zs_reasoning_deepseek,popqa::hamish_zs_reasoning_deepseek,simpleqa::tulu-thinker_deepseek,bbh:cot::hamish_zs_reasoning_deepseek_v2,gpqa:0shot_cot::hamish_zs_reasoning_deepseek,zebralogic::hamish_zs_reasoning_deepseek,agi_eval_english:0shot_cot::hamish_zs_reasoning_deepseek,minerva_math::hamish_zs_reasoning_deepseek,minerva_math_500::hamish_zs_reasoning_deepseek,gsm8k::zs_cot_latex_deepseek,omega_500:0-shot-chat_deepseek,aime:zs_cot_r1::pass_at_32_2024_deepseek,aime:zs_cot_r1::pass_at_32_2025_deepseek,codex_humanevalplus:0-shot-chat::tulu-thinker_deepseek,mbppplus:0-shot-chat::tulu-thinker_deepseek,livecodebench_codegeneration::tulu-thinker_deepseek,alpaca_eval_v3::hamish_zs_reasoning_deepseek,ifeval::hamish_zs_reasoning_deepseek --hf_entity allenai --wandb_entity ai2-llm --checkpoint_state_dir /weka/oe-adapt-default/allennlp/deletable_checkpoint_states/hamishivi/1762659314_888282 --checkpoint_state_freq 100 --output_dir /weka/oe-adapt-default/allennlp/deletable_checkpoint/hamishivi/']
    envVars:
      - name: VLLM_DISABLE_COMPILE_CACHE
        value: "1"
      - name: NCCL_DEBUG
        value: ERROR
      - name: VLLM_LOGGING_LEVEL
        value: WARNING
      - name: VLLM_USE_V1
        value: "1"
      - name: RAY_CGRAPH_get_timeout
        value: "300"
      - name: VLLM_ALLOW_LONG_MAX_MODEL_LEN
        value: "1"
      - name: HOSTED_VLLM_API_BASE
        value: http://saturn-cs-aus-235.reviz.ai2.in:8001/v1
      - name: HF_TOKEN
        secret: hamishivi_HF_TOKEN
      - name: WANDB_API_KEY
        secret: hamishivi_WANDB_API_KEY
      - name: BEAKER_TOKEN
        secret: hamishivi_BEAKER_TOKEN
      - name: OPENAI_API_KEY
        secret: hamishivi_OPENAI_API_KEY
      - name: HF_HOME
        value: /weka/oe-adapt-default/allennlp/.cache/huggingface
      - name: HF_DATASETS_CACHE
        value: /weka/oe-adapt-default/allennlp/.cache/huggingface
      - name: HF_HUB_CACHE
        value: /weka/oe-adapt-default/allennlp/.cache/hub
      - name: CHECKPOINT_OUTPUT_DIR
        value: /weka/oe-adapt-default/allennlp/deletable_checkpoint_states/buq6ny46
      - name: NCCL_SOCKET_IFNAME
        value: ib
      - name: NCCL_IB_HCA
        value: ^=mlx5_bond_0
      - name: WANDB_RUN_ID
        value: buq6ny46
      - name: WANDB_RESUME
        value: allow
    datasets:
      - mountPath: /weka/oe-adapt-default
        source:
          weka: oe-adapt-default
      - mountPath: /weka/oe-training-default
        source:
          weka: oe-training-default
    result:
      path: /output
    resources:
      gpuCount: 8
      sharedMemory: 10240 MB
    context:
      priority: urgent
      preemptible: true
    constraints:
      cluster:
        - ai2/jupiter
    hostNetworking: true
    propagateFailure: true
    propagatePreemption: true